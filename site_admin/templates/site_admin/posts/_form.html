<form
  id="post-form"
  method="post"
  enctype="multipart/form-data"
  class="flex flex-col gap-6"
  hx-post="{% if post %}{% url 'site_admin:post_edit' slug=post.slug %}{% else %}{% url 'site_admin:post_create' %}{% endif %}"
  hx-target="#post-form-messages"
  hx-swap="outerHTML"
  data-photo-upload-url="{{ photo_upload_url }}"
  data-photo-delete-url="{{ photo_delete_url }}"
  data-nearby-places-url="{{ nearby_places_url }}"
>
  {% csrf_token %}
  {% include "site_admin/posts/_form_messages.html" %}
  <div class="grid gap-6 lg:grid-cols-[minmax(0,1fr)_320px]">
    <div class="space-y-6">
      <div class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-5 shadow-sm">
        <label
          for="{{ form.kind.id_for_label }}"
          class="text-xs font-semibold uppercase tracking-[0.2em] text-[color:var(--admin-muted)]"
        >
          Post type
        </label>
        <div class="mt-3 grid grid-cols-2 gap-2 sm:grid-cols-3">
          {% for kind, label in form.fields.kind.choices %}
            <button
              type="button"
              class="kind-pill flex items-center justify-center rounded-full border border-[color:var(--admin-border)] px-3 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:border-[color:var(--admin-accent)] focus:outline-none focus-visible:ring-2 focus-visible:ring-[color:var(--admin-accent)]"
              data-kind-value="{{ kind }}"
              aria-pressed="false"
            >
              {{ label }}
            </button>
          {% endfor %}
        </div>
        <p id="kind-hint" class="mt-3 text-xs text-[color:var(--admin-muted)]">
          Choose the right flavor for this post.
        </p>
        <div class="sr-only">
          {{ form.kind }}
        </div>
      </div>

      <div>
        <label
          for="{{ form.title.id_for_label }}"
          class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
        >
          Title
        </label>
        {{ form.title }}
        {{ form.title.errors }}
      </div>
      <div>
        <label
          for="{{ form.content.id_for_label }}"
          class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
        >
          Content
        </label>
        {{ form.content }}
        <p class="mt-1 text-xs text-[color:var(--admin-muted)]" id="content-helper">
          Write the caption, note, or long-form text here.
        </p>
        {{ form.content.errors }}
      </div>

      <div class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-5 shadow-sm" data-kind-section="activity">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div>
            <label
              for="{{ form.activity_type.id_for_label }}"
              class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
            >
              Activity type
            </label>
            {{ form.activity_type }}
            <datalist id="activity-type-list">
              <option value="Hike"></option>
              <option value="Bike ride"></option>
              <option value="Run"></option>
              <option value="Walk"></option>
              <option value="Trail run"></option>
            </datalist>
            <p class="mt-1 text-xs text-[color:var(--admin-muted)]">{{ form.activity_type.help_text }}</p>
            {{ form.activity_type.errors }}
          </div>
          <div class="text-xs text-[color:var(--admin-muted)]">
            Activity posts show a map + photos.
          </div>
        </div>
        <div class="mt-4">
          <label
            for="gpx-file"
            class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
          >
            GPX track
          </label>
          <input
            type="file"
            id="gpx-file"
            name="gpx_file"
            accept=".gpx,application/gpx+xml"
            class="mt-2 w-full rounded-2xl border border-[color:var(--admin-border)] bg-white px-3 py-2 text-sm shadow-sm focus:border-[color:var(--admin-accent)] focus:ring-[color:var(--admin-accent)]"
          >
          <p class="mt-1 text-xs text-[color:var(--admin-muted)]">Upload a .gpx file so the map can render the route.</p>
          <div class="mt-3 rounded-2xl border border-[color:var(--admin-border)] bg-[color:var(--admin-bg)] px-4 py-3 text-xs text-[color:var(--admin-muted)]">
            <div class="flex flex-wrap items-center gap-3">
              <label class="flex items-center gap-2 text-[color:var(--admin-ink)]">
                <input
                  type="checkbox"
                  name="gpx_trim"
                  value="1"
                  class="h-4 w-4 rounded border-[color:var(--admin-border)] text-[color:var(--admin-accent)] focus:ring-[color:var(--admin-accent)]"
                  {% if gpx_trim_enabled %}checked{% endif %}
                >
                <span>Trim start/end</span>
              </label>
              <div class="flex items-center gap-2">
                <input
                  type="number"
                  name="gpx_trim_distance"
                  min="0"
                  step="10"
                  value="{{ gpx_trim_distance }}"
                  class="w-24 rounded-full border border-[color:var(--admin-border)] bg-white px-2 py-1 text-xs text-[color:var(--admin-ink)]"
                >
                <span>meters</span>
              </div>
            </div>
            <div class="mt-2 flex flex-wrap items-center gap-4 text-[color:var(--admin-ink)]">
              <label class="flex items-center gap-2">
                <input
                  type="checkbox"
                  name="gpx_blur"
                  value="1"
                  class="h-4 w-4 rounded border-[color:var(--admin-border)] text-[color:var(--admin-accent)] focus:ring-[color:var(--admin-accent)]"
                  {% if gpx_blur_enabled %}checked{% endif %}
                >
                <span>Blur coordinates (5-20 m)</span>
              </label>
              <label class="flex items-center gap-2">
                <input
                  type="checkbox"
                  name="gpx_remove_timestamps"
                  value="1"
                  class="h-4 w-4 rounded border-[color:var(--admin-border)] text-[color:var(--admin-accent)] focus:ring-[color:var(--admin-accent)]"
                  {% if gpx_remove_timestamps %}checked{% endif %}
                >
                <span>Remove timestamps</span>
              </label>
            </div>
            <p class="mt-2">Trim is enabled by default. Coordinate blurring and timestamp removal are optional.</p>
          </div>
          {% if activity_gpx %}
            <div class="mt-3 flex flex-wrap items-center gap-3 text-xs">
              <a href="{{ activity_gpx.url }}" class="font-semibold text-[color:var(--admin-accent)]">
                Current: {{ activity_gpx.name }}
              </a>
              <label class="flex items-center gap-2 text-[color:var(--admin-warn)]">
                <input type="checkbox" name="gpx_remove" value="1" class="h-4 w-4 rounded border-[color:var(--admin-border)] text-[color:var(--admin-accent)] focus:ring-[color:var(--admin-accent)]">
                <span>Remove GPX</span>
              </label>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-5 shadow-sm" data-kind-section="event">
        <div class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)] mb-3">Event details</div>
        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label for="{{ form.event_start.id_for_label }}" class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">Start</label>
            {{ form.event_start }}
            {{ form.event_start.errors }}
          </div>
          <div>
            <label for="{{ form.event_end.id_for_label }}" class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">End (optional)</label>
            {{ form.event_end }}
            {{ form.event_end.errors }}
          </div>
          <div>
            <label for="{{ form.event_location.id_for_label }}" class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">Location</label>
            {{ form.event_location }}
            {{ form.event_location.errors }}
          </div>
          <div>
            <label for="{{ form.event_url.id_for_label }}" class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">Event URL (optional)</label>
            {{ form.event_url }}
            {{ form.event_url.errors }}
          </div>
        </div>
        <p class="mt-3 text-xs text-[color:var(--admin-muted)]">Use the content field above for the event description.</p>
      </div>

      <div class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-5 shadow-sm" data-kind-section="rsvp">
        <div class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)] mb-3">RSVP</div>
        <div class="grid gap-4">
          <div>
            <label for="{{ form.rsvp_value.id_for_label }}" class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">Response</label>
            {{ form.rsvp_value }}
            {{ form.rsvp_value.errors }}
          </div>
        </div>
        <p class="mt-3 text-xs text-[color:var(--admin-muted)]">Set the event URL in the target URL field in the right column.</p>
      </div>

      <div class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-5 shadow-sm" data-kind-section="checkin">
        <div class="flex items-center justify-between gap-2 mb-3">
          <div class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">Check-in</div>
          <button
            type="button"
            class="rounded-full border border-[color:var(--admin-border)] px-3 py-1 text-xs font-semibold text-[color:var(--admin-accent)] transition hover:bg-[color:var(--admin-bg)]"
            data-geolocate-btn
          >
            Use my location
          </button>
        </div>
        <div class="grid gap-4 sm:grid-cols-2">
          <div class="sm:col-span-2">
            <label for="{{ form.checkin_name.id_for_label }}" class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">Place name</label>
            {{ form.checkin_name }}
            {{ form.checkin_name.errors }}
          </div>
          <div>
            <label for="{{ form.checkin_latitude.id_for_label }}" class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">Latitude</label>
            {{ form.checkin_latitude }}
            {{ form.checkin_latitude.errors }}
          </div>
          <div>
            <label for="{{ form.checkin_longitude.id_for_label }}" class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">Longitude</label>
            {{ form.checkin_longitude }}
            {{ form.checkin_longitude.errors }}
          </div>
        </div>
        <div id="checkin-map" class="mt-4 h-64 rounded-2xl border border-[color:var(--admin-border)]" data-checkin-map></div>
        <div id="checkin-suggestions" class="mt-3 hidden">
          <p class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)] mb-2">Nearby places</p>
          <div id="checkin-suggestions-list" class="flex flex-wrap gap-2"></div>
        </div>
        <p class="mt-2 text-xs text-[color:var(--admin-muted)]">Enter coordinates, click the map, or use your device location.</p>
      </div>

      <div class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-5 shadow-sm" data-kind-section="photo">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <label
              for="photo-uploader"
              class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
            >
              Photos
            </label>
            <p class="mt-1 text-xs text-[color:var(--admin-muted)]">Drop a few images and add alt text or captions.</p>
          </div>
          <button
            type="button"
            class="rounded-full border border-[color:var(--admin-border)] px-3 py-1 text-xs font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
            data-photo-trigger
          >
            Upload photos
          </button>
        </div>
        <div
          class="mt-4 flex min-h-[140px] flex-col items-center justify-center gap-2 rounded-2xl border-2 border-dashed border-[color:var(--admin-border)] bg-[color:var(--admin-bg)] px-4 py-6 text-center text-sm text-[color:var(--admin-muted)] transition"
          data-photo-dropzone
          role="button"
          tabindex="0"
          aria-label="Upload photos"
        >
          <span class="text-sm font-semibold text-[color:var(--admin-ink)]">Drop images here</span>
          <span class="text-xs">or click to browse</span>
        </div>
        <label for="photo-uploader" class="sr-only">Upload photos</label>
        <input
          type="file"
          id="photo-uploader"
          name="photos"
          accept="image/*"
          multiple
          class="sr-only"
        >
        <div id="photo-grid" class="mt-4 grid gap-4 sm:grid-cols-2"></div>
        <div id="photo-empty" class="mt-3 text-xs text-[color:var(--admin-muted)]">
          No photos yet. Photo posts can be just images and a short caption.
        </div>
        <div id="photo-metadata-fields"></div>
      </div>

      <div>
        <div class="flex items-center justify-between gap-2">
          <label
            for="{{ form.tags_text.id_for_label }}"
            class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
          >
            Tags
          </label>
          <button
            type="button"
            class="rounded-full border border-[color:var(--admin-border)] px-3 py-1 text-xs font-semibold text-[color:var(--admin-accent)] transition hover:bg-[color:var(--admin-bg)]"
            data-suggest-tags-btn
          >
            Suggest tags
          </button>
        </div>
        <div
          class="tag-input mt-1"
          data-tag-input
          data-suggest-url="{% url 'tag_suggestions' %}"
          data-suggest-content-url="{% url 'suggest_tags_for_content' %}"
        >
          <div class="tag-chips" data-tag-chips></div>
          {{ form.tags_text }}
          <div class="tag-suggestions" data-tag-suggestions hidden></div>
        </div>
        <p class="mt-1 text-xs text-[color:var(--admin-muted)]">{{ form.tags_text.help_text }}</p>
        {{ form.tags_text.errors }}
      </div>
    </div>
    <div class="space-y-5">
      <div data-kind-section="like">
        <label
          for="{{ form.like_of.id_for_label }}"
          class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
        >
          Like URL
        </label>
        {{ form.like_of }}
        <p class="mt-1 text-xs text-[color:var(--admin-muted)]">Required for like posts.</p>
        {{ form.like_of.errors }}
      </div>
      <div data-kind-section="repost">
        <label
          for="{{ form.repost_of.id_for_label }}"
          class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
        >
          Repost URL
        </label>
        {{ form.repost_of }}
        <p class="mt-1 text-xs text-[color:var(--admin-muted)]">Required for reposts.</p>
        {{ form.repost_of.errors }}
      </div>
      <div data-kind-section="reply rsvp">
        <label
          for="{{ form.in_reply_to.id_for_label }}"
          class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
        >
          Target URL
        </label>
        {{ form.in_reply_to }}
        <p class="mt-1 text-xs text-[color:var(--admin-muted)]">Required for replies and RSVPs.</p>
        {{ form.in_reply_to.errors }}
      </div>
      <div data-kind-section="bookmark">
        <label
          for="{{ form.bookmark_of.id_for_label }}"
          class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
        >
          Bookmark URL
        </label>
        {{ form.bookmark_of }}
        <p class="mt-1 text-xs text-[color:var(--admin-muted)]">Required for bookmarks.</p>
        {{ form.bookmark_of.errors }}
      </div>
      <div>
        <label
          for="{{ form.published_on.id_for_label }}"
          class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
        >
          Publish time
        </label>
        {{ form.published_on }}
        {{ form.published_on.errors }}
      </div>
      <div class="flex items-center gap-2">
        <label class="flex items-center gap-2 text-sm font-semibold text-[color:var(--admin-muted)]">
          {{ form.save_as_draft }}
          <span>Save as draft</span>
        </label>
      </div>
      <div class="flex items-center gap-2">
        <label class="flex items-center gap-2 text-sm font-semibold text-[color:var(--admin-warn)]">
          {{ form.deleted }}
          <span>Mark as deleted</span>
        </label>
      </div>
      <div>
        <label
          for="{{ form.slug.id_for_label }}"
          class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
        >
          Slug
        </label>
        {{ form.slug }}
        <p class="mt-1 text-xs text-[color:var(--admin-muted)]">Leave blank to auto-generate.</p>
        {{ form.slug.errors }}
      </div>
    </div>
  </div>
  <div class="flex flex-wrap items-center gap-3">
    <button
      type="submit"
      class="rounded-full bg-[color:var(--admin-accent)] px-5 py-2 text-sm font-semibold text-white transition hover:bg-[color:var(--admin-accent-strong)]"
    >
      Save post
    </button>
    {% if post %}
      <span class="text-xs text-[color:var(--admin-muted)]">
        {% if post.published_on %}Published{% else %}Draft{% endif %}
      </span>
    {% endif %}
  </div>
</form>

<script id="existing-photos-data" type="application/json">{{ existing_photos_json|safe }}</script>

<script>
(function () {
  const form = document.getElementById("post-form");
  if (!form || form.dataset.photoInit === "1") return;
  form.dataset.photoInit = "1";

  const kindSelect = form.querySelector('select[name="kind"]');
  const kindPills = Array.from(form.querySelectorAll("[data-kind-value]"));
  const kindHint = document.getElementById("kind-hint");
  const contentHelper = document.getElementById("content-helper");
  const kindSections = Array.from(form.querySelectorAll("[data-kind-section]"));
  const fileInput = form.querySelector("#photo-uploader");
  const dropzone = form.querySelector("[data-photo-dropzone]");
  const photoGrid = form.querySelector("#photo-grid");
  const photoEmpty = form.querySelector("#photo-empty");
  const metadataFields = form.querySelector("#photo-metadata-fields");
  const existingDataEl = document.getElementById("existing-photos-data");
  const uploadUrl = form.dataset.photoUploadUrl;
  const deleteUrl = form.dataset.photoDeleteUrl;

  const hints = {
    article: "Long-form writing with a title. Markdown works well here.",
    note: "Quick thoughts. Title optional.",
    photo: "Add photos and a caption. Keep it short and visual.",
    activity: "Map + media for hikes, rides, and other outings.",
    like: "Link to something you enjoyed.",
    repost: "Share someone else's post with credit.",
    reply: "Respond directly with a target URL.",
    event: "An event with a name, time, and location.",
    rsvp: "Respond to an event invitation.",
    checkin: "Check in at a place with coordinates.",
    bookmark: "Save a URL for later reference.",
  };

  const contentHints = {
    article: "Write the story, outline, or essay here.",
    note: "Write the short post here.",
    photo: "Add a caption or short description for the photo set.",
    activity: "Add context, highlights, or notes about the route.",
    like: "Optional commentary for the like.",
    repost: "Optional commentary for the repost.",
    reply: "Write your reply here.",
    event: "Describe the event here.",
    rsvp: "Optional commentary for your RSVP.",
    checkin: "Notes about this check-in.",
    bookmark: "Optional notes about why you're saving this.",
  };

  let photoData = [];
  const removedExisting = new Set();

  function getCsrfToken() {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? match[1] : "";
  }

  function setActivePill(kind) {
    kindPills.forEach((pill) => {
      const isActive = pill.dataset.kindValue === kind;
      pill.setAttribute("aria-pressed", isActive ? "true" : "false");
      pill.classList.toggle("bg-[color:var(--admin-accent)]", isActive);
      pill.classList.toggle("text-white", isActive);
      pill.classList.toggle("border-[color:var(--admin-accent)]", isActive);
      pill.classList.toggle("border-[color:var(--admin-border)]", !isActive);
      pill.classList.toggle("text-[color:var(--admin-ink)]", !isActive);
    });
  }

  function shouldShowSection(section, kind) {
    const tokens = section.dataset.kindSection.split(" ");
    if (tokens.includes("photo")) {
      return (
        kind === "photo" ||
        kind === "article" ||
        kind === "activity" ||
        kind === "checkin" ||
        photoData.length > 0
      );
    }
    return tokens.includes(kind);
  }

  function setKindState(kind) {
    if (!kind) return;
    if (kindSelect && kindSelect.value !== kind) {
      kindSelect.value = kind;
    }
    kindHint.textContent = hints[kind] || hints.note;
    contentHelper.textContent = contentHints[kind] || contentHints.note;
    setActivePill(kind);
    kindSections.forEach((section) => {
      const show = shouldShowSection(section, kind);
      section.classList.toggle("hidden", !show);
    });
  }

  kindPills.forEach((pill) => {
    pill.addEventListener("click", () => setKindState(pill.dataset.kindValue));
  });

  if (kindSelect) {
    kindSelect.addEventListener("change", () => setKindState(kindSelect.value));
    setKindState(kindSelect.value);
  }

  try {
    if (existingDataEl && existingDataEl.textContent.trim()) {
      const parsed = JSON.parse(existingDataEl.textContent);
      photoData = parsed.map((item, idx) => ({
        kind: item.kind || "existing",
        id: item.id,
        url: item.url,
        alt: item.alt || "",
        caption: item.caption || "",
        order: item.order ?? idx,
      }));
    }
  } catch (e) {
    photoData = [];
  }

  function renderPhotos() {
    photoGrid.innerHTML = "";
    if (!photoData.length) {
      photoEmpty.classList.remove("hidden");
      return;
    }
    photoEmpty.classList.add("hidden");
    photoData.forEach((item, idx) => {
      item.order = idx;
      photoGrid.appendChild(buildCard(item, idx));
    });
    if (kindSelect) {
      setKindState(kindSelect.value);
    }
  }

  function buildCard(item, idx) {
    const card = document.createElement("div");
    card.className =
      "flex flex-col gap-3 rounded-2xl border border-[color:var(--admin-border)] bg-white p-3 shadow-sm";

    const img = document.createElement("img");
    img.src = item.url;
    img.alt = "Selected image preview";
    img.className = "h-40 w-full rounded-xl object-cover bg-[color:var(--admin-bg)]";

    const meta = document.createElement("div");
    meta.className = "flex flex-col gap-2";

    const altInput = document.createElement("input");
    altInput.type = "text";
    altInput.placeholder = "Alt text";
    altInput.setAttribute("aria-label", "Alt text");
    altInput.value = item.alt || "";
    altInput.className =
      "w-full rounded-xl border border-[color:var(--admin-border)] bg-white px-3 py-2 text-xs focus:border-[color:var(--admin-accent)] focus:ring-[color:var(--admin-accent)]";
    altInput.addEventListener("input", (event) => {
      item.alt = event.target.value;
    });

    const captionInput = document.createElement("textarea");
    captionInput.placeholder = "Caption";
    captionInput.setAttribute("aria-label", "Caption");
    captionInput.value = item.caption || "";
    captionInput.className =
      "w-full rounded-xl border border-[color:var(--admin-border)] bg-white px-3 py-2 text-xs focus:border-[color:var(--admin-accent)] focus:ring-[color:var(--admin-accent)]";
    captionInput.rows = 2;
    captionInput.addEventListener("input", (event) => {
      item.caption = event.target.value;
    });

    meta.appendChild(altInput);
    meta.appendChild(captionInput);

    const actions = document.createElement("div");
    actions.className = "flex flex-wrap gap-2 text-xs";

    const up = document.createElement("button");
    up.type = "button";
    up.textContent = "Move up";
    up.disabled = idx === 0;
    up.className =
      "rounded-full border border-[color:var(--admin-border)] px-3 py-1 font-semibold text-[color:var(--admin-ink)] disabled:cursor-not-allowed disabled:opacity-60";
    up.addEventListener("click", () => moveCard(idx, -1));

    const down = document.createElement("button");
    down.type = "button";
    down.textContent = "Move down";
    down.disabled = idx === photoData.length - 1;
    down.className =
      "rounded-full border border-[color:var(--admin-border)] px-3 py-1 font-semibold text-[color:var(--admin-ink)] disabled:cursor-not-allowed disabled:opacity-60";
    down.addEventListener("click", () => moveCard(idx, 1));

    const copy = document.createElement("button");
    copy.type = "button";
    copy.textContent = "Copy URL";
    copy.className =
      "rounded-full border border-[color:var(--admin-border)] px-3 py-1 font-semibold text-[color:var(--admin-ink)]";
    copy.addEventListener("click", () => copyUrlToClipboard(item.url));

    const remove = document.createElement("button");
    remove.type = "button";
    remove.textContent = "Remove";
    remove.className =
      "rounded-full border border-rose-200 px-3 py-1 font-semibold text-rose-600";
    remove.addEventListener("click", async () => {
      if (item.kind === "existing") {
        removedExisting.add(item.id);
        photoData = photoData.filter((photo) => photo !== item);
        renderPhotos();
        return;
      }

      try {
        await deleteRemotePhoto(item.id);
        photoData = photoData.filter((photo) => photo !== item);
        renderPhotos();
      } catch (error) {
        alert(error.message || "Unable to delete photo.");
      }
    });

    actions.appendChild(up);
    actions.appendChild(down);
    actions.appendChild(copy);
    actions.appendChild(remove);

    card.appendChild(img);
    card.appendChild(meta);
    card.appendChild(actions);
    return card;
  }

  function moveCard(currentIndex, delta) {
    const target = currentIndex + delta;
    if (target < 0 || target >= photoData.length) return;
    const temp = photoData[currentIndex];
    photoData[currentIndex] = photoData[target];
    photoData[target] = temp;
    renderPhotos();
  }

  async function uploadPhoto(file) {
    const formData = new FormData();
    formData.append("photo", file);
    const response = await fetch(uploadUrl, {
      method: "POST",
      headers: { "X-CSRFToken": getCsrfToken() },
      body: formData,
    });
    const data = await response.json().catch(() => ({}));
    if (!response.ok || !data.id || !data.url) {
      throw new Error(data.error || "Upload failed.");
    }
    return data;
  }

  async function deleteRemotePhoto(id) {
    const formData = new FormData();
    formData.append("id", id);
    const response = await fetch(deleteUrl, {
      method: "POST",
      headers: { "X-CSRFToken": getCsrfToken() },
      body: formData,
    });
    if (!response.ok) {
      const data = await response.json().catch(() => ({}));
      throw new Error(data.error || "Delete failed.");
    }
  }

  async function copyUrlToClipboard(url) {
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(url);
        return;
      }
    } catch (e) {}

    const tempInput = document.createElement("input");
    tempInput.value = url;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand("copy");
    document.body.removeChild(tempInput);
  }

  async function handleUploads(files) {
    for (const file of files) {
      try {
        const uploaded = await uploadPhoto(file);
        photoData.push({
          kind: "uploaded",
          id: uploaded.id,
          url: uploaded.url,
          alt: "",
          caption: "",
        });
        renderPhotos();
      } catch (error) {
        alert(error.message || "Upload failed.");
      }
    }
  }

  function openFileDialog() {
    fileInput.click();
  }

  if (fileInput && dropzone) {
    dropzone.addEventListener("click", openFileDialog);
    dropzone.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        openFileDialog();
      }
    });
    const trigger = form.querySelector("[data-photo-trigger]");
    if (trigger) {
      trigger.addEventListener("click", openFileDialog);
    }

    fileInput.addEventListener("change", () => {
      const files = Array.from(fileInput.files || []);
      if (!files.length) return;
      handleUploads(files);
      fileInput.value = "";
    });

    dropzone.addEventListener("dragover", (event) => {
      event.preventDefault();
      dropzone.classList.add("border-[color:var(--admin-accent)]");
    });

    dropzone.addEventListener("dragleave", () => {
      dropzone.classList.remove("border-[color:var(--admin-accent)]");
    });

    dropzone.addEventListener("drop", (event) => {
      event.preventDefault();
      dropzone.classList.remove("border-[color:var(--admin-accent)]");
      const files = Array.from(event.dataTransfer.files || []).filter((file) =>
        file.type.startsWith("image/")
      );
      if (files.length) {
        handleUploads(files);
      }
    });
  }

  function syncMetadataFields() {
    metadataFields.innerHTML = "";
    const makeHidden = (name, value) => {
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = name;
      input.value = value;
      metadataFields.appendChild(input);
    };

    photoData.forEach((item, position) => {
      if (item.kind === "existing") {
        if (removedExisting.has(item.id)) return;
        makeHidden("existing_ids", item.id);
        makeHidden("existing_alts", item.alt || "");
        makeHidden("existing_captions", item.caption || "");
        makeHidden("existing_positions", position);
      } else {
        makeHidden("uploaded_ids", item.id);
        makeHidden("uploaded_alts", item.alt || "");
        makeHidden("uploaded_captions", item.caption || "");
        makeHidden("uploaded_positions", position);
      }
    });

    removedExisting.forEach((id) => makeHidden("existing_remove_ids", id));
  }

  form.addEventListener("submit", syncMetadataFields);
  form.addEventListener("htmx:beforeRequest", syncMetadataFields);

  renderPhotos();

  // Check-in map
  const checkinMap = form.querySelector("[data-checkin-map]");
  const latInput = form.querySelector("input[name='checkin_latitude']");
  const lngInput = form.querySelector("input[name='checkin_longitude']");
  const nameInput = form.querySelector("input[name='checkin_name']");
  const nearbyPlacesUrl = form.dataset.nearbyPlacesUrl;
  const suggestionsContainer = document.getElementById("checkin-suggestions");
  const suggestionsList = document.getElementById("checkin-suggestions-list");

  let nearbyFetchController = null;

  function fetchNearbyPlaces(lat, lng) {
    if (!nearbyPlacesUrl || !suggestionsContainer || !suggestionsList) return;
    if (nearbyFetchController) nearbyFetchController.abort();
    nearbyFetchController = new AbortController();

    fetch(`${nearbyPlacesUrl}?lat=${lat}&lng=${lng}`, {
      signal: nearbyFetchController.signal,
    })
      .then((r) => r.json())
      .then((data) => {
        suggestionsList.innerHTML = "";
        const places = data.places || [];
        if (!places.length) {
          suggestionsContainer.classList.add("hidden");
          return;
        }
        places.forEach((place) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "rounded-full border border-[color:var(--admin-border)] bg-white px-3 py-1.5 text-xs font-semibold text-[color:var(--admin-ink)] shadow-sm transition hover:border-[color:var(--admin-accent)] hover:text-[color:var(--admin-accent)]";
          const dist = place.distance_km < 1
            ? `${Math.round(place.distance_km * 1000)} m`
            : `${place.distance_km} km`;
          btn.textContent = `${place.name} (${dist})`;
          btn.addEventListener("click", () => {
            if (nameInput) nameInput.value = place.name;
            latInput.value = place.latitude;
            lngInput.value = place.longitude;
            latInput.dispatchEvent(new Event("change", { bubbles: true }));
          });
          suggestionsList.appendChild(btn);
        });
        suggestionsContainer.classList.remove("hidden");
      })
      .catch((err) => {
        if (err.name !== "AbortError") {
          suggestionsContainer.classList.add("hidden");
        }
      });
  }

  if (checkinMap && latInput && lngInput) {
    let leafletLoaded = false;
    let map = null;
    let marker = null;

    function initCheckinMap() {
      if (!window.L || leafletLoaded) return;
      leafletLoaded = true;

      const lat = parseFloat(latInput.value) || 0;
      const lng = parseFloat(lngInput.value) || 0;
      const hasCoords = latInput.value && lngInput.value;
      const center = hasCoords ? [lat, lng] : [40, -100];
      const zoom = hasCoords ? 14 : 3;

      map = L.map(checkinMap).setView(center, zoom);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
        maxZoom: 19,
      }).addTo(map);

      if (hasCoords) {
        marker = L.marker(center).addTo(map);
        fetchNearbyPlaces(lat, lng);
      }

      map.on("click", function (e) {
        const { lat, lng } = e.latlng;
        latInput.value = lat.toFixed(6);
        lngInput.value = lng.toFixed(6);
        if (marker) {
          marker.setLatLng(e.latlng);
        } else {
          marker = L.marker(e.latlng).addTo(map);
        }
        fetchNearbyPlaces(lat, lng);
      });

      function updateFromInputs() {
        const lat = parseFloat(latInput.value);
        const lng = parseFloat(lngInput.value);
        if (!isNaN(lat) && !isNaN(lng)) {
          const latlng = [lat, lng];
          if (marker) {
            marker.setLatLng(latlng);
          } else {
            marker = L.marker(latlng).addTo(map);
          }
          map.setView(latlng, Math.max(map.getZoom(), 14));
          fetchNearbyPlaces(lat, lng);
        }
      }

      latInput.addEventListener("change", updateFromInputs);
      lngInput.addEventListener("change", updateFromInputs);
    }

    // Load Leaflet dynamically when checkin kind is selected
    const observer = new MutationObserver(() => {
      if (!checkinMap.closest("[data-kind-section]").classList.contains("hidden")) {
        if (!document.querySelector('link[href*="leaflet"]')) {
          const css = document.createElement("link");
          css.rel = "stylesheet";
          css.href = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
          document.head.appendChild(css);
          const js = document.createElement("script");
          js.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
          js.onload = () => {
            initCheckinMap();
            setTimeout(() => map && map.invalidateSize(), 100);
          };
          document.head.appendChild(js);
        } else if (window.L && !leafletLoaded) {
          initCheckinMap();
        }
        if (map) {
          setTimeout(() => map.invalidateSize(), 100);
        }
      }
    });
    const checkinSection = checkinMap.closest("[data-kind-section]");
    if (checkinSection) {
      observer.observe(checkinSection, { attributes: true, attributeFilter: ["class"] });
    }

    // Geolocation
    const geoBtn = form.querySelector("[data-geolocate-btn]");
    if (geoBtn && navigator.geolocation) {
      geoBtn.addEventListener("click", () => {
        geoBtn.disabled = true;
        geoBtn.textContent = "Locating\u2026";
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            latInput.value = lat.toFixed(6);
            lngInput.value = lng.toFixed(6);
            latInput.dispatchEvent(new Event("change", { bubbles: true }));
            if (map && marker) {
              marker.setLatLng([lat, lng]);
              map.setView([lat, lng], 15);
            } else if (map) {
              marker = L.marker([lat, lng]).addTo(map);
              map.setView([lat, lng], 15);
            }
            fetchNearbyPlaces(lat, lng);
            geoBtn.disabled = false;
            geoBtn.textContent = "Use my location";
          },
          (error) => {
            geoBtn.disabled = false;
            geoBtn.textContent = "Use my location";
            alert("Could not get your location: " + error.message);
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      });
    } else if (geoBtn) {
      geoBtn.hidden = true;
    }
  }
})();
</script>
