<form id="menu-form" method="post" class="flex flex-col gap-6" data-menu-form>
  {% csrf_token %}
  {% if saved %}
    <div class="rounded-2xl border border-[color:var(--admin-border)] bg-[color:var(--admin-bg)] px-4 py-3 text-sm text-[color:var(--admin-ink)]">
      Menu saved.
    </div>
  {% endif %}
  {% if form.non_field_errors %}
    <div class="rounded-2xl border border-[color:var(--admin-border)] bg-[color:var(--admin-bg)] px-4 py-3 text-sm text-[color:var(--admin-warn)]">
      {{ form.non_field_errors }}
    </div>
  {% endif %}
  <div>
    <label
      for="{{ form.title.id_for_label }}"
      class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
    >
      Menu name
    </label>
    {{ form.title }}
    {{ form.title.errors }}
  </div>

  <div class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <div class="text-sm font-semibold">Menu items</div>
      <p class="mt-1 text-xs text-[color:var(--admin-muted)]">Add links and adjust ordering. Lower numbers appear first.</p>
    </div>
    <button
      type="button"
      class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
      data-add-menu-item
    >
      Add item
    </button>
  </div>

  {{ formset.management_form }}
  {% if formset.non_form_errors %}
    <div class="rounded-2xl border border-[color:var(--admin-border)] bg-[color:var(--admin-bg)] px-4 py-3 text-sm text-[color:var(--admin-warn)]">
      {{ formset.non_form_errors }}
    </div>
  {% endif %}

  <div class="grid gap-4" data-menu-items>
    {% for item_form in formset %}
      <div class="rounded-2xl border border-[color:var(--admin-border)] bg-white p-4" data-menu-item>
        {{ item_form.id }}
        <div class="grid gap-4 md:grid-cols-[minmax(0,1fr)_minmax(0,1fr)_140px]">
          <div>
            <label
              for="{{ item_form.text.id_for_label }}"
              class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
            >
              Label
            </label>
            {{ item_form.text }}
            {{ item_form.text.errors }}
          </div>
          <div>
            <label
              for="{{ item_form.url.id_for_label }}"
              class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
            >
              URL
            </label>
            {{ item_form.url }}
            {{ item_form.url.errors }}
          </div>
          <div>
            <label
              for="{{ item_form.weight.id_for_label }}"
              class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
            >
              Order
            </label>
            {{ item_form.weight }}
            {{ item_form.weight.errors }}
          </div>
        </div>
        <div class="mt-3 flex items-center justify-between gap-2">
          <button
            type="button"
            class="inline-flex items-center gap-2 rounded-full border border-[color:var(--admin-border)] px-3 py-1 text-xs font-semibold text-[color:var(--admin-warn)] transition hover:bg-[color:var(--admin-bg)]"
            {% if item_form.instance.pk %}
              hx-post="{% url 'site_admin:menu_item_delete' item_id=item_form.instance.pk %}"
              hx-target="closest [data-menu-item]"
              hx-swap="delete"
              hx-confirm="Remove this menu item?"
            {% else %}
              data-remove-menu-item
            {% endif %}
          >
            <svg aria-hidden="true" viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18"></path>
              <path d="M8 6V4h8v2"></path>
              <path d="M6 6l1 14h10l1-14"></path>
            </svg>
            <span class="menu-item__label">Remove item</span>
            <span class="menu-item__deleting hidden text-[color:var(--admin-muted)]">Deleting...</span>
          </button>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="rounded-2xl border border-dashed border-[color:var(--admin-border)] bg-[color:var(--admin-bg)] px-4 py-5 text-center text-sm text-[color:var(--admin-muted)]{% if formset.total_form_count %} hidden{% endif %}" data-menu-empty>
    No items yet. Add your first link.
  </div>

  <div class="flex flex-wrap items-center gap-3">
    <button
      type="submit"
      class="rounded-full bg-[color:var(--admin-accent)] px-5 py-2 text-sm font-semibold text-white transition hover:bg-[color:var(--admin-accent-strong)]"
    >
      Save menu
    </button>
    {% if menu %}
      <span class="text-xs text-[color:var(--admin-muted)]">{{ formset.total_form_count }} item{{ formset.total_form_count|pluralize }}</span>
    {% endif %}
  </div>
</form>

<template id="menu-item-template">
  <div class="rounded-2xl border border-[color:var(--admin-border)] bg-white p-4" data-menu-item>
    {{ formset.empty_form.id }}
    <div class="grid gap-4 md:grid-cols-[minmax(0,1fr)_minmax(0,1fr)_140px]">
      <div>
        <label
          for="{{ formset.empty_form.text.id_for_label }}"
          class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
        >
          Label
        </label>
        {{ formset.empty_form.text }}
      </div>
      <div>
        <label
          for="{{ formset.empty_form.url.id_for_label }}"
          class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
        >
          URL
        </label>
        {{ formset.empty_form.url }}
      </div>
      <div>
        <label
          for="{{ formset.empty_form.weight.id_for_label }}"
          class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
        >
          Order
        </label>
        {{ formset.empty_form.weight }}
      </div>
    </div>
    <div class="mt-3 flex items-center gap-2">
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-full border border-[color:var(--admin-border)] px-3 py-1 text-xs font-semibold text-[color:var(--admin-warn)] transition hover:bg-[color:var(--admin-bg)]"
        data-remove-menu-item
      >
        <svg aria-hidden="true" viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 6h18"></path>
          <path d="M8 6V4h8v2"></path>
          <path d="M6 6l1 14h10l1-14"></path>
        </svg>
        Remove item
      </button>
    </div>
  </div>
</template>

<style>
  .htmx-request .menu-item__label {
    display: none;
  }

  .htmx-request .menu-item__deleting {
    display: inline;
  }
</style>

<script>
(function () {
  const form = document.getElementById("menu-form");
  if (!form || form.dataset.menuInit === "1") return;
  form.dataset.menuInit = "1";

  const addButton = form.querySelector("[data-add-menu-item]");
  const itemsContainer = form.querySelector("[data-menu-items]");
  const emptyState = form.querySelector("[data-menu-empty]");
  const totalForms = form.querySelector("#id_items-TOTAL_FORMS");
  const initialForms = form.querySelector("#id_items-INITIAL_FORMS");
  const template = document.getElementById("menu-item-template");

  function updateEmptyState() {
    if (!emptyState || !itemsContainer) return;
    const count = itemsContainer.querySelectorAll("[data-menu-item]").length;
    emptyState.classList.toggle("hidden", count > 0);
  }

  function reindexForms() {
    if (!itemsContainer || !totalForms) return;
    const forms = Array.from(itemsContainer.querySelectorAll("[data-menu-item]"));
    forms.forEach((formEl, index) => {
      formEl.querySelectorAll("input, select, textarea, label").forEach((field) => {
        if (field.name) {
          field.name = field.name.replace(/items-\\d+-/g, `items-${index}-`);
        }
        if (field.id) {
          field.id = field.id.replace(/items-\\d+-/g, `items-${index}-`);
        }
        if (field.htmlFor) {
          field.htmlFor = field.htmlFor.replace(/items-\\d+-/g, `items-${index}-`);
        }
      });
    });
    totalForms.value = forms.length;
    if (initialForms) {
      const existingCount = forms.filter((formEl) => {
        const idInput = formEl.querySelector('input[name$="-id"]');
        return idInput && idInput.value;
      }).length;
      initialForms.value = existingCount;
    }
  }

  function removeItem(button) {
    const row = button.closest("[data-menu-item]");
    if (!row) return;
    row.remove();
    reindexForms();
    updateEmptyState();
  }

  function addItem() {
    if (!template || !itemsContainer || !totalForms) return;
    const index = parseInt(totalForms.value, 10);
    const fragment = template.content.cloneNode(true);
    const html = fragment.firstElementChild.innerHTML.replace(/__prefix__/g, index);
    fragment.firstElementChild.innerHTML = html;
    itemsContainer.appendChild(fragment);
    totalForms.value = index + 1;
    updateEmptyState();
  }

  if (addButton) {
    addButton.addEventListener("click", addItem);
  }

  form.addEventListener("click", (event) => {
    const button = event.target.closest("[data-remove-menu-item]");
    if (button) {
      event.preventDefault();
      removeItem(button);
    }
  });

  function extractRequestPath(detail) {
    return (
      (detail.requestConfig && detail.requestConfig.path) ||
      (detail.pathInfo && detail.pathInfo.requestPath) ||
      detail.path ||
      ""
    );
  }

  document.body.addEventListener("htmx:afterRequest", (event) => {
    const detail = event.detail || {};
    const requestPath = extractRequestPath(detail);
    if (!requestPath.includes("/admin/settings/menus/items/")) return;
    setTimeout(() => {
      reindexForms();
      updateEmptyState();
    }, 0);
  });

  updateEmptyState();
})();
</script>
