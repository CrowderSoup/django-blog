{% extends "site_admin/base.html" %}

{% block title %}User agents{% endblock %}

{% block content %}
  <div class="analytics-layout grid gap-6 lg:grid-cols-[220px_1fr]">
    {% include "site_admin/analytics/_sidebar.html" %}
    <div class="flex flex-col gap-6">
      <section class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-6 shadow-sm">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div>
            <div class="text-sm uppercase tracking-[0.2em] text-[color:var(--admin-muted)]">Analytics</div>
            <h1 class="text-2xl font-semibold">User agents</h1>
            <p class="mt-1 text-sm text-[color:var(--admin-muted)]">
              Search and manage user agents from {{ start_date|date:"M j, Y" }} to {{ end_date|date:"M j, Y" }}.
            </p>
          </div>
          <a
            href="{% url 'site_admin:analytics_dashboard' %}"
            class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
          >
            Back to overview
          </a>
        </div>

        <div class="mt-4 flex flex-wrap items-end justify-between gap-3">
          <div class="flex flex-wrap items-end gap-2 text-sm">
            {% for preset in presets.values %}
              <a
                href="{% url 'site_admin:analytics_user_agents' %}?start={{ preset.start }}&end={{ preset.end }}{% if query %}&q={{ query|urlencode }}{% endif %}"
                class="rounded-full border border-[color:var(--admin-border)] px-3 py-1 text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)] transition hover:bg-[color:var(--admin-bg)]"
              >
                {{ preset.label }}
              </a>
            {% endfor %}
          </div>
          <form method="get" class="flex flex-wrap items-end gap-2">
            <label for="analytics-query" class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">
              <span>Search</span>
              <input
                type="text"
                name="q"
                value="{{ query }}"
                id="analytics-query"
                placeholder="bot, curl, Mozilla"
                class="w-52 rounded-full border border-[color:var(--admin-border)] bg-white px-3 py-2 text-sm"
              />
            </label>
            <label for="analytics-start" class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">
              <span>Start date</span>
              <input
                type="date"
                name="start"
                value="{{ start_date|date:'Y-m-d' }}"
                id="analytics-start"
                class="w-40 rounded-full border border-[color:var(--admin-border)] bg-white px-3 py-2 text-sm"
              />
            </label>
            <label for="analytics-end" class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">
              <span>End date</span>
              <input
                type="date"
                name="end"
                value="{{ end_date|date:'Y-m-d' }}"
                id="analytics-end"
                class="w-40 rounded-full border border-[color:var(--admin-border)] bg-white px-3 py-2 text-sm"
              />
            </label>
            <button
              type="submit"
              class="rounded-full bg-[color:var(--admin-accent)] px-4 py-2 text-sm font-semibold text-white transition hover:bg-[color:var(--admin-accent-strong)]"
            >
              Update
            </button>
          </form>
        </div>

        {% include "site_admin/_messages.html" with wrapper_class="mt-6 space-y-2" %}
      </section>

      <section class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-6 shadow-sm">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Matching user agents</h2>
          <div class="flex flex-wrap items-center gap-3 text-sm">
            <span class="text-[color:var(--admin-muted)]">Showing up to 100 results</span>
            {% if query %}
              <form
                method="post"
                action="{% url 'site_admin:analytics_ignore_user_agents_bulk' %}"
                data-confirm-message="Ignore all user agents matching “{{ query|escapejs }}”?"
              >
                {% csrf_token %}
                <input type="hidden" name="q" value="{{ query }}" />
                <input type="hidden" name="start" value="{{ start_date|date:'Y-m-d' }}" />
                <input type="hidden" name="end" value="{{ end_date|date:'Y-m-d' }}" />
                <input type="hidden" name="ignore_all" value="1" />
                <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                <button
                  type="submit"
                  class="rounded-full border border-[color:var(--admin-border)] px-3 py-1 text-xs font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
                >
                  Ignore all matches
                </button>
              </form>
            {% endif %}
          </div>
        </div>
        <form method="post" action="{% url 'site_admin:analytics_ignore_user_agents_bulk' %}">
          {% csrf_token %}
          <input type="hidden" name="q" value="{{ query }}" />
          <input type="hidden" name="start" value="{{ start_date|date:'Y-m-d' }}" />
          <input type="hidden" name="end" value="{{ end_date|date:'Y-m-d' }}" />
          <input type="hidden" name="next" value="{{ request.get_full_path }}" />
          <div class="mt-4 overflow-hidden rounded-2xl border border-[color:var(--admin-border)]">
            <table class="min-w-full table-fixed text-left text-sm">
              <thead class="bg-[color:var(--admin-bg)] text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">
                <tr>
                  <th scope="col" class="px-4 py-3 w-10">
                    <input
                      type="checkbox"
                      id="analytics-select-all"
                      class="h-4 w-4 rounded border-[color:var(--admin-border)]"
                      aria-label="Select all matching user agents"
                    />
                  </th>
                  <th scope="col" class="px-4 py-3 w-full">User agent</th>
                  <th scope="col" class="px-4 py-3 w-28">Count</th>
                  <th scope="col" class="px-4 py-3 w-40">Last seen</th>
                  <th scope="col" class="px-4 py-3 w-28">Action</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-[color:var(--admin-border)]">
                {% for row in user_agents %}
                  <tr>
                    <td class="px-4 py-3">
                      {% if row.user_agent in ignored_user_agents %}
                        <span class="text-xs text-[color:var(--admin-muted)]">—</span>
                      {% else %}
                        <input
                          type="checkbox"
                          name="user_agents"
                          value="{{ row.user_agent }}"
                          class="analytics-select h-4 w-4 rounded border-[color:var(--admin-border)]"
                          aria-label="Select {{ row.user_agent }}"
                        />
                      {% endif %}
                    </td>
                    <td class="px-4 py-3 text-[color:var(--admin-ink)] min-w-0 max-w-0 overflow-hidden">
                      <div class="block w-full truncate" title="{{ row.user_agent }}">{{ row.user_agent|default:"(unknown)" }}</div>
                    </td>
                    <td class="px-4 py-3 text-[color:var(--admin-ink)]">{{ row.count }}</td>
                    <td class="px-4 py-3 text-[color:var(--admin-ink)]">{{ row.last_seen|date:"M j, Y" }}</td>
                    <td class="px-4 py-3">
                      {% if row.user_agent in ignored_user_agents %}
                        <span class="rounded-full bg-[color:var(--admin-bg)] px-3 py-1 text-xs font-semibold text-[color:var(--admin-muted)]">
                          Ignored
                        </span>
                      {% else %}
                        <button
                          type="submit"
                          name="user_agents"
                          value="{{ row.user_agent }}"
                          class="rounded-full border border-[color:var(--admin-border)] px-3 py-1 text-xs font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
                        >
                          Ignore
                        </button>
                      {% endif %}
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="5" class="px-4 py-3 text-[color:var(--admin-muted)]">
                      No user agents found. Try broad terms like “bot”, “curl”, or “Mozilla”.
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="mt-4 flex flex-wrap items-center justify-between gap-3">
            <p class="text-xs text-[color:var(--admin-muted)]">
              Select user agents to ignore them in bulk.
            </p>
            <button
              type="submit"
              class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-xs font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
            >
              Ignore selected
            </button>
          </div>
        </form>
      </section>
    </div>
  </div>
{% endblock %}

{% block body_end %}
  <script>
    (() => {
      const selectAll = document.getElementById("analytics-select-all");
      const items = Array.from(document.querySelectorAll(".analytics-select"));
      if (!selectAll || !items.length) return;
      selectAll.addEventListener("change", () => {
        items.forEach((item) => {
          item.checked = selectAll.checked;
        });
      });
      items.forEach((item) => {
        item.addEventListener("change", () => {
          selectAll.checked = items.every((checkbox) => checkbox.checked);
        });
      });
    })();
    (() => {
      const forms = document.querySelectorAll("[data-confirm-message]");
      if (!forms.length) return;
      forms.forEach((form) => {
        form.addEventListener("submit", (event) => {
          const message = form.getAttribute("data-confirm-message");
          if (!message) return;
          if (!window.confirm(message)) {
            event.preventDefault();
          }
        });
      });
    })();
  </script>
{% endblock %}
