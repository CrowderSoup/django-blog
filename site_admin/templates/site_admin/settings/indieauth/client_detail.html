{% extends "site_admin/base.html" %}

{% block title %}IndieAuth client{% endblock %}

{% block content %}
  <div class="site-settings-layout grid gap-6 lg:grid-cols-[220px_1fr]">
    {% include "site_admin/settings/_sidebar.html" %}
    <div class="flex flex-col gap-6">
      <section class="flex flex-wrap items-start justify-between gap-4">
        <div>
          <div class="text-sm uppercase tracking-[0.2em] text-[color:var(--admin-muted)]">Site settings</div>
          <h1 class="text-2xl font-semibold">IndieAuth client</h1>
          <p class="mt-1 text-sm text-[color:var(--admin-muted)]">{{ client.name|default:client.client_id }}</p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <a
            href="{% url 'site_admin:indieauth_settings' %}"
            class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
          >
            Back to IndieAuth
          </a>
          <form method="post" class="inline">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete_client" />
            <button
              type="submit"
              class="rounded-full border border-rose-200 px-4 py-2 text-sm font-semibold text-rose-600 transition hover:bg-rose-50"
              onclick="return confirm('Remove this client and revoke its tokens?');"
            >
              Remove client
            </button>
          </form>
        </div>
      </section>

      {% include "site_admin/_messages.html" with wrapper_class="space-y-2" %}

      <section class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-6 shadow-sm">
        <h2 class="text-lg font-semibold">Client details</h2>
        <div class="mt-4 grid gap-4 md:grid-cols-2">
          <div>
            <div class="text-xs uppercase tracking-[0.2em] text-[color:var(--admin-muted)]">Client ID</div>
            <div class="mt-1 text-sm text-[color:var(--admin-ink)] break-words">{{ client.client_id }}</div>
          </div>
          <div>
            <div class="text-xs uppercase tracking-[0.2em] text-[color:var(--admin-muted)]">Last fetched</div>
            <div class="mt-1 text-sm text-[color:var(--admin-ink)]">{{ client.last_fetched_at|date:"M j, Y"|default:"-" }}</div>
          </div>
          <div>
            <div class="text-xs uppercase tracking-[0.2em] text-[color:var(--admin-muted)]">Redirect URIs</div>
            <div class="mt-1 text-sm text-[color:var(--admin-ink)]">
              {% if client.redirect_uris %}
                <ul class="list-disc pl-5">
                  {% for uri in client.redirect_uris %}
                    <li class="break-words">{{ uri }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="text-[color:var(--admin-muted)]">None recorded</span>
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-xs uppercase tracking-[0.2em] text-[color:var(--admin-muted)]">Fetch error</div>
            <div class="mt-1 text-sm text-[color:var(--admin-ink)]">{{ client.fetch_error|default:"-" }}</div>
          </div>
        </div>
      </section>

      <section class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-6 shadow-sm">
        <h2 class="text-lg font-semibold">Access tokens</h2>
        {% if tokens %}
          <div class="mt-4 hidden md:block">
            <div class="overflow-hidden rounded-2xl border border-[color:var(--admin-border)]">
              <table class="w-full table-fixed text-left text-sm">
                <thead class="bg-[color:var(--admin-bg)] text-xs uppercase tracking-widest text-[color:var(--admin-muted)]">
                  <tr>
                    <th class="px-4 py-3">User</th>
                    <th class="px-4 py-3">Me</th>
                    <th class="px-4 py-3">Scope</th>
                    <th class="px-4 py-3 w-32">Created</th>
                    <th class="px-4 py-3 w-32">Expires</th>
                    <th class="px-4 py-3 w-32">Revoked</th>
                    <th class="px-4 py-3 w-32">Token</th>
                    <th class="px-4 py-3 w-28"></th>
                  </tr>
                </thead>
                <tbody>
                  {% for token in tokens %}
                    <tr class="border-t border-[color:var(--admin-border)]">
                      <td class="px-4 py-3 text-[color:var(--admin-muted)]">
                        {{ token.user.get_username }}
                      </td>
                      <td class="px-4 py-3 text-[color:var(--admin-muted)]">
                        <span class="block max-w-[200px] truncate">{{ token.me }}</span>
                      </td>
                      <td class="px-4 py-3 text-[color:var(--admin-muted)]">
                        <span class="block max-w-[160px] truncate">{{ token.scope|default:"-" }}</span>
                      </td>
                      <td class="px-4 py-3 text-[color:var(--admin-muted)]">{{ token.created_at|date:"M j, Y" }}</td>
                      <td class="px-4 py-3 text-[color:var(--admin-muted)]">{{ token.expires_at|date:"M j, Y"|default:"-" }}</td>
                      <td class="px-4 py-3 text-[color:var(--admin-muted)]">{{ token.revoked_at|date:"M j, Y"|default:"-" }}</td>
                      <td class="px-4 py-3 font-mono text-xs text-[color:var(--admin-muted)]">{{ token.redacted_hash }}</td>
                      <td class="px-4 py-3 text-right">
                        {% if token.revoked_at %}
                          <span class="text-xs font-semibold text-[color:var(--admin-muted)]">Revoked</span>
                        {% else %}
                          <form method="post" class="inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="revoke_token" />
                            <input type="hidden" name="token_id" value="{{ token.id }}" />
                            <button
                              type="submit"
                              class="text-sm font-semibold text-rose-600"
                              onclick="return confirm('Revoke this access token?');"
                            >
                              Revoke
                            </button>
                          </form>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="mt-4 flex flex-col gap-3 md:hidden">
            {% for token in tokens %}
              <div class="rounded-2xl border border-[color:var(--admin-border)] p-4">
                <div class="text-base font-semibold">{{ token.user.get_username }}</div>
                <div class="mt-1 text-sm text-[color:var(--admin-muted)]">
                  <div class="truncate">Me: {{ token.me }}</div>
                  <div>Scope: {{ token.scope|default:"-" }}</div>
                  <div>Token: {{ token.redacted_hash }}</div>
                </div>
                <div class="mt-3 flex items-center gap-3">
                  {% if token.revoked_at %}
                    <span class="text-xs font-semibold text-[color:var(--admin-muted)]">Revoked</span>
                  {% else %}
                    <form method="post" class="inline">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="revoke_token" />
                      <input type="hidden" name="token_id" value="{{ token.id }}" />
                      <button
                        type="submit"
                        class="text-sm font-semibold text-rose-600"
                        onclick="return confirm('Revoke this access token?');"
                      >
                        Revoke
                      </button>
                    </form>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="mt-4 rounded-2xl border border-dashed border-[color:var(--admin-border)] p-6 text-sm text-[color:var(--admin-muted)]">
            No access tokens issued for this client.
          </div>
        {% endif %}
      </section>

      <section class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-6 shadow-sm">
        <h2 class="text-lg font-semibold">Remembered consents</h2>
        {% if consents %}
          <div class="mt-4 hidden md:block">
            <div class="overflow-hidden rounded-2xl border border-[color:var(--admin-border)]">
              <table class="w-full table-fixed text-left text-sm">
                <thead class="bg-[color:var(--admin-bg)] text-xs uppercase tracking-widest text-[color:var(--admin-muted)]">
                  <tr>
                    <th class="px-4 py-3">User</th>
                    <th class="px-4 py-3">Scope</th>
                    <th class="px-4 py-3 w-32">Created</th>
                    <th class="px-4 py-3 w-32">Last used</th>
                  </tr>
                </thead>
                <tbody>
                  {% for consent in consents %}
                    <tr class="border-t border-[color:var(--admin-border)]">
                      <td class="px-4 py-3 text-[color:var(--admin-muted)]">{{ consent.user.get_username }}</td>
                      <td class="px-4 py-3 text-[color:var(--admin-muted)]">
                        <span class="block max-w-[240px] truncate">{{ consent.scope|default:"-" }}</span>
                      </td>
                      <td class="px-4 py-3 text-[color:var(--admin-muted)]">{{ consent.created_at|date:"M j, Y" }}</td>
                      <td class="px-4 py-3 text-[color:var(--admin-muted)]">{{ consent.last_used_at|date:"M j, Y"|default:"-" }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="mt-4 flex flex-col gap-3 md:hidden">
            {% for consent in consents %}
              <div class="rounded-2xl border border-[color:var(--admin-border)] p-4">
                <div class="text-base font-semibold">{{ consent.user.get_username }}</div>
                <div class="mt-1 text-sm text-[color:var(--admin-muted)]">
                  <div>Scope: {{ consent.scope|default:"-" }}</div>
                  <div>Created: {{ consent.created_at|date:"M j, Y" }}</div>
                  <div>Last used: {{ consent.last_used_at|date:"M j, Y"|default:"-" }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="mt-4 rounded-2xl border border-dashed border-[color:var(--admin-border)] p-6 text-sm text-[color:var(--admin-muted)]">
            No remembered consents for this client.
          </div>
        {% endif %}
      </section>
    </div>
  </div>
{% endblock %}
