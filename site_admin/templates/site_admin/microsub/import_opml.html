{% extends "site_admin/base.html" %}

{% block title %}Import OPML{% endblock %}

{% block content %}
  <div class="site-settings-layout grid gap-6 lg:grid-cols-[220px_1fr]">
    {% include "site_admin/settings/_sidebar.html" %}
    <div class="flex flex-col gap-6">
      <section class="flex flex-wrap items-start justify-between gap-4">
        <div>
          <div class="text-sm uppercase tracking-[0.2em] text-[color:var(--admin-muted)]">Microsub</div>
          <h1 class="text-2xl font-semibold">Import OPML</h1>
          <p class="mt-1 text-sm text-[color:var(--admin-muted)]">
            Upload an OPML file to import channels and feed subscriptions. Existing channels and
            feeds will not be duplicated.
          </p>
        </div>
        <a
          href="{% url 'site_admin:microsub_channel_list' %}"
          class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
        >
          Cancel
        </a>
      </section>

      {% include "site_admin/_messages.html" with wrapper_class="space-y-2" %}

      {% if not results %}
        <section class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-6 shadow-sm">
          <form method="post" enctype="multipart/form-data" class="flex flex-col gap-4 max-w-md">
            {% csrf_token %}
            <div>
              <label
                for="{{ form.opml_file.id_for_label }}"
                class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]"
              >
                OPML file
              </label>
              <div class="mt-1">{{ form.opml_file }}</div>
              {% if form.opml_file.errors %}
                <div class="mt-1 text-xs text-rose-600">{{ form.opml_file.errors|join:", " }}</div>
              {% endif %}
              <p class="mt-1 text-xs text-[color:var(--admin-muted)]">
                Accepts <code>.opml</code> or <code>.xml</code> files. Feed groups in the OPML file
                become channels; ungrouped feeds are placed in an &ldquo;Uncategorized&rdquo; channel.
              </p>
            </div>
            <div>
              <button
                type="submit"
                class="rounded-full bg-[color:var(--admin-accent)] px-6 py-2 text-sm font-semibold text-white shadow-sm transition hover:opacity-90"
              >
                Import
              </button>
            </div>
          </form>
        </section>
      {% else %}
        <section class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-6 shadow-sm">
          <h2 class="text-lg font-semibold">Import results</h2>
          <p class="mt-1 text-sm text-[color:var(--admin-muted)]">
            {{ results.new_feeds }} new feed{{ results.new_feeds|pluralize }} imported across
            {{ results.channels|length }} channel{{ results.channels|length|pluralize }}.
          </p>

          <div class="mt-4 overflow-hidden rounded-2xl border border-[color:var(--admin-border)]">
            <table class="w-full table-fixed text-left text-sm">
              <thead class="bg-[color:var(--admin-bg)] text-xs uppercase tracking-widest text-[color:var(--admin-muted)]">
                <tr>
                  <th class="px-4 py-3">Channel</th>
                  <th class="px-4 py-3 w-28">Status</th>
                  <th class="px-4 py-3 w-24">Feeds</th>
                  <th class="px-4 py-3 w-24">New</th>
                  <th class="px-4 py-3 w-20"></th>
                </tr>
              </thead>
              <tbody>
                {% for row in results.channels %}
                  <tr class="border-t border-[color:var(--admin-border)]">
                    <td class="px-4 py-3 font-semibold">{{ row.channel.name }}</td>
                    <td class="px-4 py-3">
                      {% if row.created %}
                        <span class="rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-semibold text-emerald-700">Created</span>
                      {% else %}
                        <span class="rounded-full bg-[color:var(--admin-bg)] px-2 py-0.5 text-xs text-[color:var(--admin-muted)]">Existing</span>
                      {% endif %}
                    </td>
                    <td class="px-4 py-3 text-[color:var(--admin-muted)]">{{ row.feeds_total }}</td>
                    <td class="px-4 py-3 text-[color:var(--admin-muted)]">{{ row.feeds_new }}</td>
                    <td class="px-4 py-3 text-right">
                      <a
                        href="{% url 'site_admin:microsub_channel_detail' uid=row.channel.uid %}"
                        class="text-sm font-semibold text-[color:var(--admin-accent)]"
                      >
                        View
                      </a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="mt-4 flex gap-3">
            <a
              href="{% url 'site_admin:microsub_channel_list' %}"
              class="rounded-full bg-[color:var(--admin-accent)] px-6 py-2 text-sm font-semibold text-white shadow-sm transition hover:opacity-90"
            >
              Done
            </a>
            <a
              href="{% url 'site_admin:microsub_import_opml' %}"
              class="rounded-full border border-[color:var(--admin-border)] px-6 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
            >
              Import another
            </a>
          </div>
        </section>
      {% endif %}
    </div>
  </div>
{% endblock %}
