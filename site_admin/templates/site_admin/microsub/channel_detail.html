{% extends "site_admin/base.html" %}

{% block title %}{{ channel.name }} â€“ Microsub{% endblock %}

{% block content %}
  <div class="site-settings-layout grid gap-6 lg:grid-cols-[220px_1fr]">
    {% include "site_admin/settings/_sidebar.html" %}
    <div class="flex flex-col gap-6">
      <section class="flex flex-wrap items-start justify-between gap-4">
        <div>
          <div class="text-sm uppercase tracking-[0.2em] text-[color:var(--admin-muted)]">Microsub</div>
          <h1 class="text-2xl font-semibold">{{ channel.name }}</h1>
          <p class="mt-1 text-sm text-[color:var(--admin-muted)]">
            {{ unread_count }} unread &middot; {{ entry_count }} total entries
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <a
            href="{% url 'site_admin:microsub_feed_add' uid=channel.uid %}"
            class="rounded-full bg-[color:var(--admin-accent)] px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:opacity-90"
          >
            Add feed
          </a>
          {% if unread_count %}
            <form method="post" action="{% url 'site_admin:microsub_channel_mark_read' uid=channel.uid %}">
              {% csrf_token %}
              <button
                type="submit"
                class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
              >
                Mark all read
              </button>
            </form>
          {% endif %}
          <a
            href="{% url 'site_admin:microsub_channel_edit' uid=channel.uid %}"
            class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
          >
            Rename
          </a>
          {% if channel.uid != "notifications" %}
            <a
              href="{% url 'site_admin:microsub_channel_delete' uid=channel.uid %}"
              class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-sm font-semibold text-rose-600 transition hover:bg-rose-50"
            >
              Delete
            </a>
          {% endif %}
          <a
            href="{% url 'site_admin:microsub_channel_list' %}"
            class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
          >
            Back
          </a>
        </div>
      </section>

      {% include "site_admin/_messages.html" with wrapper_class="space-y-2" %}

      <section class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-6 shadow-sm">
        <h2 class="text-lg font-semibold">Subscriptions</h2>

        {% if subscriptions %}
          <div class="mt-4 hidden md:block">
            <div class="overflow-hidden rounded-2xl border border-[color:var(--admin-border)]">
              <table class="w-full table-fixed text-left text-sm">
                <thead class="bg-[color:var(--admin-bg)] text-xs uppercase tracking-widest text-[color:var(--admin-muted)]">
                  <tr>
                    <th class="px-4 py-3">Feed URL</th>
                    <th class="px-4 py-3 w-40">Last fetched</th>
                    <th class="px-4 py-3 w-48">Status</th>
                    <th class="px-4 py-3 w-24"></th>
                  </tr>
                </thead>
                <tbody>
                  {% for sub in subscriptions %}
                    <tr class="border-t border-[color:var(--admin-border)]">
                      <td class="px-4 py-3">
                        <div class="font-semibold">{{ sub.name|default:sub.url|truncatechars:60 }}</div>
                        {% if sub.name %}
                          <div class="mt-0.5 text-xs text-[color:var(--admin-muted)] truncate">{{ sub.url }}</div>
                        {% endif %}
                        {% if sub.websub_hub %}
                          <div class="mt-0.5 text-xs text-[color:var(--admin-muted)]">WebSub {% if sub.websub_subscribed_at %}<span class="text-green-600">active</span>{% else %}hub found{% endif %}</div>
                        {% endif %}
                      </td>
                      <td class="px-4 py-3 text-[color:var(--admin-muted)]">
                        {{ sub.last_fetched_at|date:"M j, Y H:i"|default:"Never" }}
                      </td>
                      <td class="px-4 py-3">
                        {% if sub.fetch_error %}
                          <span class="text-xs text-rose-600 block truncate max-w-[180px]" title="{{ sub.fetch_error }}">{{ sub.fetch_error|truncatechars:50 }}</span>
                        {% else %}
                          <span class="text-xs text-[color:var(--admin-muted)]">OK</span>
                        {% endif %}
                      </td>
                      <td class="px-4 py-3 text-right">
                        <form method="post" action="{% url 'site_admin:microsub_feed_remove' uid=channel.uid feed_id=sub.pk %}" class="inline">
                          {% csrf_token %}
                          <button
                            type="submit"
                            class="text-sm font-semibold text-rose-600"
                            onclick="return confirm('Remove this feed subscription and its entries?');"
                          >
                            Remove
                          </button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="mt-4 flex flex-col gap-3 md:hidden">
            {% for sub in subscriptions %}
              <div class="rounded-2xl border border-[color:var(--admin-border)] p-4">
                <div class="text-base font-semibold">{{ sub.name|default:sub.url|truncatechars:60 }}</div>
                {% if sub.name %}
                  <div class="mt-0.5 text-xs text-[color:var(--admin-muted)] truncate">{{ sub.url }}</div>
                {% endif %}
                <div class="mt-1 text-sm text-[color:var(--admin-muted)]">
                  Last fetched: {{ sub.last_fetched_at|date:"M j, Y"|default:"Never" }}
                </div>
                {% if sub.fetch_error %}
                  <div class="mt-1 text-xs text-rose-600">{{ sub.fetch_error|truncatechars:80 }}</div>
                {% endif %}
                <div class="mt-3">
                  <form method="post" action="{% url 'site_admin:microsub_feed_remove' uid=channel.uid feed_id=sub.pk %}" class="inline">
                    {% csrf_token %}
                    <button
                      type="submit"
                      class="text-sm font-semibold text-rose-600"
                      onclick="return confirm('Remove this feed?');"
                    >
                      Remove
                    </button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="mt-4 rounded-2xl border border-dashed border-[color:var(--admin-border)] p-6 text-sm text-[color:var(--admin-muted)]">
            No feeds subscribed yet.
            <a href="{% url 'site_admin:microsub_feed_add' uid=channel.uid %}" class="font-semibold text-[color:var(--admin-accent)]">Add one</a>.
          </div>
        {% endif %}
      </section>
    </div>
  </div>
{% endblock %}
