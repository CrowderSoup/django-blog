{% extends "site_admin/base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
  <div class="flex flex-col gap-6">
    <section class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-6 shadow-sm">
      <h1 class="text-2xl font-semibold">Welcome back</h1>
      <p class="mt-2 text-[color:var(--admin-muted)]">
        Manage your content, keep drafts moving, and publish with confidence.
      </p>
      <div class="mt-5 flex flex-wrap gap-3">
        <a
          href="{% url 'site_admin:post_create' %}"
          class="rounded-full bg-[color:var(--admin-accent)] px-4 py-2 text-sm font-semibold text-white transition hover:bg-[color:var(--admin-accent-strong)]"
        >
          New post
        </a>
        <a
          href="{% url 'site_admin:post_list' %}"
          class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
        >
          View all posts
        </a>
      </div>
    </section>

    <section class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-6 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">Analytics snapshot</h2>
          <p class="text-sm text-[color:var(--admin-muted)]">Last 7 days</p>
        </div>
        <a
          href="{% url 'site_admin:analytics_dashboard' %}"
          class="text-sm font-semibold text-[color:var(--admin-accent)]"
        >
          View full analytics
        </a>
      </div>
      <div class="mt-5 grid gap-4 sm:grid-cols-2 xl:grid-cols-4">
        <div class="rounded-2xl border border-[color:var(--admin-border)] bg-[color:var(--admin-bg)] p-4">
          <div class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">Page views</div>
          <div class="mt-2 text-2xl font-semibold">
            {{ analytics_stats.total_page_views|default:0 }}
          </div>
        </div>
        <div class="rounded-2xl border border-[color:var(--admin-border)] bg-[color:var(--admin-bg)] p-4">
          <div class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">Sessions</div>
          <div class="mt-2 text-2xl font-semibold">
            {{ analytics_stats.unique_sessions|default:0 }}
          </div>
        </div>
        <div class="rounded-2xl border border-[color:var(--admin-border)] bg-[color:var(--admin-bg)] p-4">
          <div class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">Users</div>
          <div class="mt-2 text-2xl font-semibold">
            {{ analytics_stats.unique_users|default:0 }}
          </div>
        </div>
        <div class="rounded-2xl border border-[color:var(--admin-border)] bg-[color:var(--admin-bg)] p-4">
          <div class="text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">Avg. time (sec)</div>
          <div class="mt-2 text-2xl font-semibold">
            {{ analytics_stats.avg_duration|default:0|floatformat:0 }}
          </div>
        </div>
      </div>
      <div class="mt-6 grid gap-6 lg:grid-cols-[2fr,1fr]">
        <div class="rounded-2xl border border-[color:var(--admin-border)] p-4">
          <div class="text-sm font-semibold">Daily page views</div>
          <div class="mt-3 h-48 min-w-0 overflow-hidden">
            <canvas id="analytics-summary-chart" class="h-full w-full"></canvas>
          </div>
        </div>
        <div class="rounded-2xl border border-[color:var(--admin-border)] p-4">
          <div class="text-sm font-semibold">Top pages</div>
          <div class="mt-3 space-y-2 text-sm">
            {% for row in analytics_top_paths %}
              <div class="flex items-center justify-between gap-3">
                <div class="truncate text-[color:var(--admin-ink)]" title="{{ row.path }}">
                  {{ row.path }}
                </div>
                <div class="rounded-full bg-[color:var(--admin-bg)] px-2 py-1 text-xs font-semibold text-[color:var(--admin-muted)]">
                  {{ row.count }}
                </div>
              </div>
            {% empty %}
              <p class="text-sm text-[color:var(--admin-muted)]">No analytics data yet.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </section>

    <section class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Recent posts</h2>
        <a href="{% url 'site_admin:post_list' %}" class="text-sm font-medium text-[color:var(--admin-accent)]">
          View list
        </a>
      </div>
      <div class="mt-4 grid gap-4">
        {% for post in recent_posts %}
          <div class="flex flex-col gap-1 rounded-2xl border border-[color:var(--admin-border)] px-4 py-3">
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div class="text-base font-semibold">{{ post.title }}</div>
              <span class="rounded-full bg-[color:var(--admin-bg)] px-3 py-1 text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">
                {{ post.get_kind_display }}
              </span>
            </div>
            <div class="text-sm text-[color:var(--admin-muted)]">
              {% if post.published_on %}
                Published {{ post.published_on|date:"M j, Y" }}
              {% else %}
                Draft
              {% endif %}
            </div>
            <div class="pt-2">
              <a
                href="{% url 'site_admin:post_edit' slug=post.slug %}"
                class="text-sm font-semibold text-[color:var(--admin-accent)]"
              >
                Edit
              </a>
            </div>
          </div>
        {% empty %}
          <p class="text-sm text-[color:var(--admin-muted)]">No posts yet. Start with a new one.</p>
        {% endfor %}
      </div>
    </section>
  </div>
{% endblock %}

{% block body_end %}
  {{ analytics_labels|json_script:"analytics-summary-labels" }}
  {{ analytics_counts|json_script:"analytics-summary-counts" }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const labels = JSON.parse(
      document.getElementById("analytics-summary-labels").textContent
    );
    const counts = JSON.parse(
      document.getElementById("analytics-summary-counts").textContent
    );
    const ctx = document.getElementById("analytics-summary-chart");
    if (ctx && window.Chart) {
      new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Page views",
              data: counts,
              borderColor: "#0f766e",
              backgroundColor: "rgba(15, 118, 110, 0.15)",
              borderWidth: 2,
              tension: 0.35,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: "#6b6a69" },
            },
            y: {
              grid: { color: "rgba(229, 223, 214, 0.6)" },
              ticks: { color: "#6b6a69", precision: 0 },
            },
          },
        },
      });
    }
  </script>
{% endblock %}
